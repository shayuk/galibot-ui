<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GaliBot â€“ Streaming + ×¤×¨×•××¤×˜×™× ×©×™××•×©×™×™×</title>

  <style>
    :root {
      --bg: #f5f5f5;
      --panel: #ffffff;
      --text: #111111;
      --muted: #666666;
      --border: #e3e3e3;
      --shadow: rgba(0, 0, 0, 0.10);

      --accent: #007bff;
      --accentText: #ffffff;

      --botBg: #e9ecef;
      --userBg: #007bff;
      --userText: #ffffff;

      --statusBg: #fff3cd;
      --statusText: #856404;

      --btnBg: #007bff;
      --btnText: #ffffff;

      --btnSecondaryBg: #eef2f7;
      --btnSecondaryText: #111111;

      --successBg: #1a7f37;
      --successText: #ffffff;

      --codeBg: #f3f5f7;
      --codeBorder: #e1e6eb;

      --focus: rgba(0, 123, 255, 0.35);
      --attachBtnSize: 44px;
      --thumbSize: 48px;
    }

    html[data-theme="dark"] {
      --bg: #0f1216;
      --panel: #151a21;
      --text: #e9eef5;
      --muted: #aab6c5;
      --border: #2a3240;
      --shadow: rgba(0, 0, 0, 0.35);

      --accent: #4da3ff;
      --accentText: #0b1220;

      --botBg: #202734;
      --userBg: #4da3ff;
      --userText: #08101f;

      --statusBg: #2a2f1c;
      --statusText: #f0e7b3;

      --btnBg: #4da3ff;
      --btnText: #0b1220;

      --btnSecondaryBg: #222a37;
      --btnSecondaryText: #e9eef5;

      --successBg: #2ea043;
      --successText: #07120a;

      --codeBg: #10151c;
      --codeBorder: #263042;

      --focus: rgba(77, 163, 255, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    /* Layout: ×©××™× ××ª ×”-sidebar "×¤×™×–×™×ª" ×‘×¦×“ ×©×××œ, ×œ××¨×•×ª RTL */
    .app-shell {
      height: 100vh;
      display: grid;
      grid-template-columns: 320px 1fr;
      direction: ltr; /* ×—×©×•×‘ ×›×“×™ ×©×”×¢××•×“×” ×”×¨××©×•× ×” ×ª×”×™×” ×‘×¦×“ ×©×××œ */
    }

    /* Overlay ×œ× ×™×™×“ */
    .scrim {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      z-index: 40;
    }
    .scrim.open { display: block; }

    /* Sidebar */
    aside.sidebar {
      direction: rtl;
      background: var(--panel);
      border-right: 1px solid var(--border);
      box-shadow: 0 2px 10px var(--shadow);
      height: 100vh;
      overflow: auto;
      padding: 14px 14px 12px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      font-size: 16px;
      margin: 0;
      letter-spacing: 0.2px;
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
      margin: 8px 0 12px;
      line-height: 1.4;
    }

    details.group {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: transparent;
      margin-bottom: 10px;
      overflow: hidden;
    }

    details.group > summary {
      list-style: none;
      cursor: pointer;
      padding: 10px 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      user-select: none;
      background: rgba(0,0,0,0.02);
    }

    html[data-theme="dark"] details.group > summary {
      background: rgba(255,255,255,0.03);
    }

    details.group > summary::-webkit-details-marker { display: none; }

    details.group > summary .chev {
      font-size: 12px;
      color: var(--muted);
    }

    details.group[open] > summary .chev { transform: rotate(180deg); }
    details.group > summary .chev { transition: transform 160ms ease; }

    .prompt-list {
      padding: 10px 10px 12px;
      display: grid;
      gap: 10px;
    }

    details.prompt {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--panel);
      overflow: hidden;
    }

    details.prompt > summary {
      list-style: none;
      cursor: pointer;
      padding: 10px 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      user-select: none;
    }

    details.prompt > summary::-webkit-details-marker { display: none; }

    .prompt-title {
      font-weight: 700;
      font-size: 13px;
      line-height: 1.25;
    }

    .prompt-desc {
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.35;
    }

    .copy-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--btnSecondaryBg);
      color: var(--btnSecondaryText);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 120ms ease, background 160ms ease, color 160ms ease, border-color 160ms ease;
    }
    .copy-btn:hover { transform: translateY(-1px); }
    .copy-btn:active { transform: translateY(0px); }

    .copy-btn.copied {
      background: var(--successBg);
      color: var(--successText);
      border-color: transparent;
    }

    .prompt-body {
      padding: 0 10px 10px;
    }

    .prompt-text {
      margin: 0;
      padding: 10px;
      background: var(--codeBg);
      border: 1px solid var(--codeBorder);
      border-radius: 10px;
      white-space: pre-wrap;
      font-size: 12px;
      line-height: 1.45;
      color: var(--text);
    }

    .sidebar-footer {
      border-top: 1px solid var(--border);
      margin-top: 10px;
      padding-top: 10px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    /* Main */
    main.main {
      direction: rtl;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header.topbar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px var(--shadow);
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand {
      display: grid;
      gap: 2px;
    }
    .brand h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.2px;
    }
    .brand .subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--btnSecondaryBg);
      color: var(--btnSecondaryText);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 120ms ease, background 160ms ease, color 160ms ease, border-color 160ms ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .icon-btn:hover { transform: translateY(-1px); }
    .icon-btn:active { transform: translateY(0px); }

    .mobile-only { display: none; }

    section.chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 14px;
      gap: 10px;
    }

    #chatMessages {
      flex: 1;
      overflow: auto;
      padding: 10px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .message {
      margin: 10px 0;
      padding: 10px 12px;
      border-radius: 12px;
      max-width: 85%;
      white-space: pre-wrap;
      line-height: 1.45;
      font-size: 14px;
    }

    .user-message {
      background: var(--userBg);
      color: var(--userText);
      margin-inline-end: auto; /* ×‘-RTL ×–×” ××¦××™×“ ×œ×™××™×Ÿ (×”×ª×—×œ×”) */
      text-align: right;
    }

    .bot-message {
      background: var(--botBg);
      color: var(--text);
      margin-inline-start: auto; /* ×‘-RTL ×–×” ××¦××™×“ ×œ×©×××œ (×¡×•×£) */
      text-align: right;
    }

    .status {
      padding: 10px 12px;
      background: var(--statusBg);
      color: var(--statusText);
      border-radius: 12px;
      font-size: 13px;
      display: none;
      border: 1px solid rgba(0,0,0,0.05);
    }
    html[data-theme="dark"] .status {
      border: 1px solid rgba(255,255,255,0.08);
    }
    .status.streaming { display: block; }

    .input-container {
      display: grid;
      grid-template-columns: 220px 1fr var(--attachBtnSize) 120px;
      gap: 10px;
      align-items: center;
    }

    input {
      width: 100%;
      padding: 12px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: var(--panel);
      color: var(--text);
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--focus);
    }

    #sendButton {
      padding: 12px 14px;
      background: var(--btnBg);
      color: var(--btnText);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: transform 120ms ease, opacity 160ms ease;
    }

    #sendButton:hover { transform: translateY(-1px); }
    #sendButton:active { transform: translateY(0px); }
    #sendButton:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    #attachButton {
      width: var(--attachBtnSize);
      height: var(--attachBtnSize);
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .image-preview {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      margin-top: 8px;
    }

    .image-preview.active { display: flex; }

    .image-preview img {
      width: var(--thumbSize);
      height: var(--thumbSize);
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .image-preview-meta {
      font-size: 12px;
      color: var(--muted);
      flex: 1;
    }

    .remove-image-btn {
      padding: 6px 10px;
      font-size: 12px;
    }

    /* Responsive (Mobile) */
    @media (max-width: 980px) {
      .app-shell {
        grid-template-columns: 1fr;
      }

      /* Sidebar ×”×•×¤×š ×œ-Drawer */
      aside.sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: min(92vw, 360px);
        z-index: 50;
        transform: translateX(-110%);
        transition: transform 180ms ease;
      }

      aside.sidebar.open { transform: translateX(0); }

      .mobile-only { display: inline-flex; }

      section.chat { padding: 12px; }

      .input-container {
        grid-template-columns: 1fr;
      }

      #attachButton {
        width: 100%;
        height: auto;
        padding: 12px 14px;
        justify-content: center;
      }

      #sendButton { width: 100%; }

      .message { max-width: 95%; }
    }

    .legal-banner {
      border-top: 1px solid var(--border);
      padding: 10px 14px;
      background: var(--panel);
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 10px;
    }
  </style>
  
  <!-- MathJax for LaTeX formula rendering -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        enableMenu: false
      },
      startup: {
        ready: () => {
          console.log('MathJax is ready');
          MathJax.startup.defaultReady();
        }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
  <div class="scrim" id="scrim" aria-hidden="true"></div>

  <div class="app-shell">
    <!-- Sidebar (Left) -->
    <aside class="sidebar" id="sidebar" aria-label="×¤×¨×•××¤×˜×™× ×©×™××•×©×™×™×">
      <div class="sidebar-header">
        <h2>×¤×¨×•××¤×˜×™× ×©×™××•×©×™×™×</h2>
        <button class="icon-btn mobile-only" id="closeSidebarBtn" type="button" aria-label="×¡×’×•×¨ ×—×œ×•×Ÿ ×¤×¨×•××¤×˜×™×">
          âœ• ×¡×’×•×¨
        </button>
      </div>

      <div class="hint">
        ×˜×™×¤: ×œ×—×¦×• ×¢×œ ×¤×¨×•××¤×˜ ×›×“×™ ×œ×¨××•×ª ××•×ª×•, ×•××– â€œ×”×¢×ª×§â€ â†’ ×”×“×‘×§×” ×œ×ª×™×‘×ª ×”×”×•×“×¢×” â†’ ×¢×¨×™×›×” ×§×œ×” â†’ ×©×œ×™×—×”.
      </div>

      <details class="group" open>
        <summary>
          <span>×¤×¨×•××¤×˜×™× ×‘×¡×™×¡×™×™×</span>
          <span class="chev">â–¼</span>
        </summary>
        <div class="prompt-list" id="basicPrompts"></div>
      </details>

      <details class="group">
        <summary>
          <span>×¤×¨×•××¤×˜×™× ××ª×§×“××™×</span>
          <span class="chev">â–¼</span>
        </summary>
        <div class="prompt-list" id="advancedPrompts"></div>
      </details>

      <div class="sidebar-footer">
        <div><strong>×‘×œ×•× (×ª×–×›×•×¨×ª ××”×™×¨×”):</strong></div>
        <div>×™×“×¢ = ×”×’×“×¨×•×ª â€¢ ×”×‘× ×” = ×œ×”×¡×‘×™×¨ ×‘××™×œ×™× ×©×œ×š â€¢ ×™×™×©×•× = ×œ×”×¤×¢×™×œ × ×•×¡×—×” â€¢ × ×™×ª×•×— = ×œ×”×©×•×•×ª/×œ×”×¡×™×§ â€¢ ×¡×™× ×ª×–×” = ×œ×™×¦×•×¨ ×™×™×¦×•×’/×¤×ª×¨×•×Ÿ ×—×“×© â€¢ ×”×¢×¨×›×” = ×œ×©×¤×•×˜ ×× × ×™×ª×•×— × ×›×•×Ÿ</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="brand">
          <h1>GaliBot</h1>
          <div class="subtitle">Streaming + UI ××©×•×“×¨×’ (Sidebar + Dark Mode + Mobile)</div>
        </div>

        <div class="topbar-actions">
          <button class="icon-btn mobile-only" id="openSidebarBtn" type="button" aria-label="×¤×ª×— ×¤×¨×•××¤×˜×™× ×©×™××•×©×™×™×">
            â˜° ×¤×¨×•××¤×˜×™×
          </button>

          <button class="icon-btn" id="themeToggleBtn" type="button" aria-label="×”×—×œ×£ ××¦×‘ ×›×”×”/×‘×”×™×¨" title="××¦×‘ ×›×”×”/×‘×”×™×¨">
            ğŸŒ™ ××¦×‘ ×›×”×”
          </button>
        </div>
      </header>

      <section class="chat">
        <div id="chatMessages" aria-label="×”×•×“×¢×•×ª ×¦'××˜"></div>

        <div class="status" id="status" role="status" aria-live="polite">
          ×××ª×™×Ÿ ×œ×ª×©×•×‘×”...
        </div>

        <div class="input-container">
          <input type="email" id="emailInput" placeholder="×”×›× ×¡/×™ ×›×ª×•×‘×ª ××™×™×œ" value="test@ariel.ac.il" />
          <input type="text" id="messageInput" placeholder="×›×ª×‘×• ×©××œ×” ×›××Ÿ..." onkeypress="handleKeyPress(event)" />
          <button class="icon-btn" id="attachButton" type="button" aria-label="×¦×¨×£ ×ª××•× ×”" title="×¦×¨×£ ×ª××•× ×”">ğŸ“</button>
          <button id="sendButton" type="button" onclick="sendMessage()">×©×œ×—</button>
          <input type="file" id="imageInput" accept="image/png,image/jpeg,image/webp" hidden />
        </div>

        <div class="image-preview" id="imagePreview" aria-live="polite">
          <img id="imagePreviewImg" alt="×ª×¦×•×’×” ××§×“×™××” ×©×œ ×ª××•× ×” ××¦×•×¨×¤×ª" />
          <div class="image-preview-meta" id="imagePreviewMeta"></div>
          <button class="icon-btn remove-image-btn" id="removeImageButton" type="button" aria-label="×”×¡×¨ ×ª××•× ×”" title="×”×¡×¨ ×ª××•× ×”">âœ•</button>
        </div>

        <div class="legal-banner" dir="rtl" lang="he">
          ×›×œ ×—×•××¨×™ ×”×”×•×¨××”, ×”×“×•×’×××•×ª ×•×”×ª×›× ×™× ×‘×‘×•×˜ ×–×” × ×›×ª×‘×• ×•××•×©×¨×• ×¢×œ-×™×“×™ ×“×´×¨ ×’×œ×™×ª ××“×¨. Â© ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.
        </div>
      </section>
    </main>
  </div>

  <script>
    // =========================
    // Config
    // =========================
    const API_BASE_URL = 'https://lecturers-gpt-server.onrender.com';
    const API_URL = `${API_BASE_URL}/api/ask/stream`;
    const UPLOAD_URL = `${API_BASE_URL}/api/upload-image`;
    const BYTES_PER_KB = 1024;
    const KB_PER_MB = 1024;
    const MAX_IMAGE_BYTES = 10 * BYTES_PER_KB * KB_PER_MB;
    const ALLOWED_IMAGE_TYPES = new Set(['image/jpeg', 'image/png', 'image/webp']);
    const HISTORY_MAX_TURNS = 12;
    const HISTORY_MAX_TOTAL_CHARS = 12000;
    const HISTORY_MAX_MESSAGE_CHARS = 4000;
    const HISTORY_MAX_BUFFER_TURNS = 60;
    // ××• ×œ×”×©×ª××© ×‘: const API_URL = 'https://lecturers-gpt-server.onrender.com/api/ask?stream=true';

    // =========================
    // Prompt Catalog
    // (×“×•×’×××•×ª "×‘×¡×’× ×•×Ÿ" ×”××“×¨×™×š ×©×©×œ×—×ª â€” ××¤×©×¨ ×œ×¢×¨×•×š ×—×•×¤×©×™)
    // =========================
    const BASIC_PROMPTS = [
      {
        title: "×¤×ª×™×—×ª ×©×™×—×” â€“ ×¨×©×™××ª × ×•×©××™ ×”×§×•×¨×¡",
        desc: "×›×“×™ ×œ×§×‘×œ â€œ××¤×ª ×“×¨×›×™×â€ ×©×œ ×”×§×•×¨×¡ ×œ×¤×™ ×¡×“×¨",
        text:
`MODE=STUDY_PLAN
×¦×•×¨/×™ ××¤×ª ×“×¨×›×™× ×§×¦×¨×” ×œ×§×•×¨×¡/× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×›×œ×•×œ/×™ 6â€“8 × ×•×©××™× ×œ×¤×™ ×¡×“×¨, ×•×œ×›×œ × ×•×©× ×™×¢×“ ×œ×™××•×“×™ ×§×¦×¨.
×‘×¡×•×£ ×ª×Ÿ/×™ ××©×™××” ×¨××©×•× ×” ×§×˜× ×” ×œ×”×ª×—×œ×” ×”×™×•×.`
      },
      {
        title: "×”×¡×‘×¨ ×¤×©×•×˜ ×œ××•×©×’ (×¢× ×“×•×’××”)",
        desc: "×›×©××•×©×’ ×‘×¡×™×¡×™ ×œ× ×‘×¨×•×¨ ×•×¨×•×¦×™× ×”×¡×‘×¨ ×™×“×™×“×•×ª×™",
        text:
`×”×¡×‘×¨/×™ ×‘×¤×©×˜×•×ª ××ª ×”××•×©×’: [××•×©×’].
×× ×œ× ×¦×™×™× ×ª×™ ××•×©×’, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×ª×Ÿ/×™ ×”×¡×‘×¨ ×§×¦×¨ ×‘×©×¤×” ×™×“×™×“×•×ª×™×ª + ×“×•×’××” ××¡×¤×¨×™×ª ×§×˜× ×” (4â€“5 ××¡×¤×¨×™×) ×¢× ×—×™×©×•×‘ ×§×¦×¨.
×‘×¡×•×£ ×ª×Ÿ/×™ ×©××œ×” ××—×ª ×œ×‘×“×™×§×” ×¢×¦××™×ª (×‘×œ×™ ×¤×ª×¨×•×Ÿ).`
      },
      {
        title: "××•×©×’ ×’×¨×¤×™/×”×ª×¤×œ×’×•×ª (×•×™×–×•××œ×™ + ××™×œ×•×œ×™)",
        desc: "×œ××©×œ: ××¡×™××˜×¨×™×” ×™×× ×™×ª/×©×××œ×™×ª, ×–× ×‘×•×ª, ×¦×•×¨×ª ×’×¨×£",
        text:
`×”×¡×‘×¨/×™ ××™×š × ×¨××” ×”××•×©×’ ×”×’×¨×¤×™/×”×ª×¤×œ×’×•×ª: [××•×©×’].
×× ×œ× ×¦×™×™× ×ª×™ ××•×©×’, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×ª××¨/×™ ×‘××™×œ×™× + ×ª×Ÿ/×™ ×“×•×’××” ××¡×¤×¨×™×ª ×§×¦×¨×” ×©××“×’×™××” ×–××ª.
×‘×¡×•×£ ×ª×Ÿ/×™ ×©××œ×” ××—×ª ×œ×‘×“×™×§×” ×¢×¦××™×ª (×‘×œ×™ ×¤×ª×¨×•×Ÿ).`
      },
      {
        title: "×”×‘×“×œ ×‘×™×Ÿ ×××•×¦×¢ / ×—×¦×™×•×Ÿ / ×©×›×™×—",
        desc: "××ª×™ ×›×œ ××“×“ ××ª××™× + ×“×•×’××” ×œ×¢×¨×š ×§×™×¦×•×Ÿ ×©××˜×¢×”",
        text:
`×¢×©×”/×™ ×¡×“×¨ ×‘×™×Ÿ ×××•×¦×¢, ×—×¦×™×•×Ÿ ×•×©×›×™×—: ×”×’×“×¨×” ×§×¦×¨×” + ××ª×™ ×›×œ ××—×“ ××ª××™×.
×”×•×¡×£/×™ ×“×•×’××” ×¢× ×¢×¨×š ×§×™×¦×•×Ÿ ×©××˜×¢×” ××ª ×”×××•×¦×¢ ×•×”×¡×‘×¨/×™ ×œ××” ×”×—×¦×™×•×Ÿ ×¢×“×™×£.
×‘×¡×•×£ ×ª×Ÿ/×™ ×©××œ×” ×§×¦×¨×” ×œ×‘×“×™×§×” ×¢×¦××™×ª (×‘×œ×™ ×¤×ª×¨×•×Ÿ).`
      },
      {
        title: "×¨×™×¢× ×•×Ÿ ×§×¦×¨ (×¡×™×›×•× ×ª××¦×™×ª×™)",
        desc: "×¡×™×›×•× 5â€“6 ×©×•×¨×•×ª + 2 ×©××œ×•×ª ×‘×“×™×§×”",
        text:
`MODE=SUMMARY
×ª×Ÿ/×™ ×¡×™×›×•× ×§×¦×¨ (×¢×“ 6 ×©×•×¨×•×ª) ×¢×œ: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×‘×¡×•×£ ×”×•×¡×£/×™ 2 ×©××œ×•×ª ×§×¦×¨×•×ª ×œ×‘×“×™×§×” ×¢×¦××™×ª (×‘×œ×™ ×¤×ª×¨×•×Ÿ).`
      },
      {
        title: "×ª×¨×’×•×œ ×¨×‘-×‘×¨×™×¨×” ×‘×¡×’× ×•×Ÿ ××‘×—×Ÿ",
        desc: "4 ××¡×™×—×™×, ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×œ× ×œ×—×©×•×£ ×¤×ª×¨×•× ×•×ª ××™×“",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 8 ×©××œ×•×ª ×¨×‘Ö¾×‘×¨×™×¨×” ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××©, ×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×•×ª×Ÿ/×™ ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×ª×¨×’×•×œ ×”×“×¨×’×ª×™ â€“ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×",
        desc: "××©×•×‘ ××—×¨×™ ×›×œ ×ª×©×•×‘×” (× ×›×•×Ÿ/×œ× × ×›×•×Ÿ + ×”×¡×‘×¨ + ×ª×™×§×•×Ÿ ×˜×¢×•×ª)",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ ×ª×¨×’×•×œ ×”×“×¨×’×ª×™ ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××©, ×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×•×ª×Ÿ/×™ ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×ª×¨×’×•×œ ×§×¨×™××ª ×¤×œ×˜ SPSS",
        desc: "×¤×œ×˜ ×“××™×•× ×™ ×§×¦×¨ + ×©××œ×” ×¢×œ ×”×¤×œ×˜",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ ×©××œ×” ×¨×‘-×‘×¨×™×¨×” ×¢×œ ×¤×œ×˜ SPSS ×“××™×•× ×™ ×§×¦×¨ ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×—×™×©×•×‘×™× â€œ×™×‘×©×™×â€ ×¢× ×¢×¨×›×™× ×§×˜× ×™×",
        desc: "××ª××™× ×œ×ª×¨×’×•×œ ×‘×œ×™ ××¡×¤×¨×™× ×¢× ×§×™×™× ××• ×—×™×©×•×‘×™× ×›×‘×“×™×",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ ×©××œ×•×ª ×¨×‘-×‘×¨×™×¨×” ×—×™×©×•×‘×™×•×ª ×¢× ××¡×¤×¨×™× ×§×˜× ×™× ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      }
    ];

    const ADVANCED_PROMPTS = [
      {
        title: "×¡×˜ ×¨×‘-× ×•×©××™ ××•×ª×× (×¨×‘-×‘×¨×™×¨×”)",
        desc: "× ×•×©××™× ×©×•× ×™× + ××¡×¤×¨ ×©××œ×•×ª ×œ×›×œ × ×•×©× + ×§×•×©×™ + ×‘×œ×•× + ×ª×™××•×¨×™×”/×—×™×©×•×‘",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ ×¡×˜ ×¨×‘Ö¾×‘×¨×™×¨×” ×¨×‘Ö¾× ×•×©××™ ×‘×ª×•×š ×ª×—×•××™ ×”×œ×™×‘×” ×©×œ: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢× ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ×¤× ×™ ×”××©×•×‘.`
      },
      {
        title: "×‘×œ×•× â€“ ×™×“×¢ (×”×’×“×¨×•×ª)",
        desc: "×™×“×¢ = ×œ×–×›×•×¨/×œ×–×”×•×ª ×”×’×“×¨×•×ª (×¨××” × ××•×›×”)",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 5 ×©××œ×•×ª ×§×¦×¨×•×ª ×‘×¨××ª ×™×“×¢ ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×‘×œ×•× â€“ ×”×‘× ×” (×”×¡×‘×¨ ×‘××™×œ×™× ×©×œ×™)",
        desc: "×”×‘× ×” = ×œ×”×¡×‘×™×¨ ××©××¢×•×ª (×¨××” × ××•×›×”â€“×‘×™× ×•× ×™×ª)",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 4 ×©××œ×•×ª ×‘×¨××ª ×”×‘× ×” ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×‘×œ×•× â€“ ×™×™×©×•× (×ª×¨×’×•×œ × ×•×¡×—××•×ª/×—×™×©×•×‘ ×¤×©×•×˜)",
        desc: "×™×™×©×•× = ×©×™××•×© ×‘×›×œ×™/× ×•×¡×—×” ×‘××¦×‘ ×—×“×© (×‘×™× ×•× ×™×ª)",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 5 ×ª×¨×’×™×œ×™ ×™×™×©×•× ×§×¦×¨×™× ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×‘×œ×•× â€“ × ×™×ª×•×— (×”×©×•×•××”/×”×¡×§×ª ××¡×§× ×•×ª)",
        desc: "× ×™×ª×•×— = ×œ×¤×¨×§ ××¦×‘, ×œ×”×©×•×•×ª, ×œ×”×¡×™×§ (×‘×™× ×•× ×™×ªâ€“×’×‘×•×”×”)",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 3 ×©××œ×•×ª × ×™×ª×•×— ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×‘×œ×•× â€“ ×”×¢×¨×›×” (×©×™×¤×•×˜ ×”×—×œ×˜×” ×¡×˜×˜×™×¡×˜×™×ª)",
        desc: "×”×¢×¨×›×” = ×œ×©×¤×•×˜ ×× ×‘×—×™×¨×ª ××“×“/××‘×—×Ÿ ×”×™×™×ª×” ×˜×•×‘×” (×’×‘×•×”×”)",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 2 ×©××œ×•×ª ×”×¢×¨×›×” ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×¡×˜ ×‘×—×™× ×” ×¢× ×¤×™×œ×•×— ××—×•×–×™×",
        desc: "×—×œ×•×§×ª ×§×•×©×™ + ×¢×¨×‘×•×‘ ×ª×™××•×¨×™×”/×—×™×©×•×‘",
        text:
`MODE=FULL_EXAM_20
×‘× ×”/×™ ×¢×‘×•×¨×™ 20 ×©××œ×•×ª ×‘×¤×•×¨××˜ ×‘×—×™× ×” ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×¤×™×œ×•×—: 20% ×§×œ, 30% ×‘×™× ×•× ×™, 40% ×§×©×”, 10% ×§×©×” ×××•×“; 50% ×ª×™××•×¨×™×”, 50% ×—×™×©×•×‘ ×¢× ××¡×¤×¨×™× ×§×˜× ×™×.
×œ×›×œ ×©××œ×” 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢× ×‘×œ×‘×“; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××™×“ ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×ª×¨×—×™×©×™× ×œ×‘×—×™×¨×ª ××‘×—×Ÿ ×¡×˜×˜×™×¡×˜×™",
        desc: "×ª×¨×’×•×œ ×”×ª×××ª ××‘×—×Ÿ ×œ×¤×™ ×¡×•×’ ××©×ª× ×™× ×•×¡×•×œ× ××“×™×“×”",
        text:
`MODE=PRACTICE_EXAM
×¦×•×¨/×™ 6 ×ª×¨×—×™×©×™× ×§×¦×¨×™× ×‘× ×•×©×: [× ×•×©×].
×× ×œ× ×¦×™×™× ×ª×™ × ×•×©×, ×‘×—×¨/×™ × ×•×©× ××¨×›×–×™ ××ª×•×š ×—×•××¨ ×”×§×•×¨×¡ ×‘×××’×¨ ×•×”×ª×—×œ/×™ ××× ×•.
×œ×›×œ ×ª×¨×—×™×© 4 ××¤×©×¨×•×™×•×ª (Aâ€“D), ×ª×©×•×‘×” ××—×ª × ×›×•× ×”, ×•×¨× ×“×•××™×–×¦×™×” ×©×œ ××™×§×•× ×”×ª×©×•×‘×”.
×”×¦×’/×™ ×ª×¨×—×™×© ××—×“ ×‘×›×œ ×¤×¢×; ××œ ×ª×¦×™×’/×™ ×¤×ª×¨×•× ×•×ª ××¨××© ×•×”××ª×Ÿ/×™ ×œ×ª×©×•×‘×ª×™ ×œ××©×•×‘ ××¢××™×§.`
      },
      {
        title: "×‘×“×™×§×ª ×¤×ª×¨×•×Ÿ ×©×× ×™ ×›×ª×‘×ª×™",
        desc: "×”×‘×•×˜ ×›×‘×•×—×Ÿ: ×œ×–×”×•×ª ×˜×¢×•×™×•×ª ×•×œ×©×¤×¨ × ×™×¡×•×—",
        text:
`MODE=CHECK_MY_SOLUTION
×”×“×‘×§/×™ ××ª ×”×©××œ×” ×”××§×•×¨×™×ª ×•××ª ×”×¤×ª×¨×•×Ÿ ×”××œ× ×©×œ×š.
×× ×œ× ×”×“×‘×§×ª ×©××œ×”+×¤×ª×¨×•×Ÿ, ×‘×§×©/×™ ×©××“×‘×™×§ ××•×ª× ×œ×¤× ×™ ×”××©×š.
×‘×“×•×§/×™ × ×›×•× ×•×ª; ×× ×™×© ×˜×¢×•×ª â€” ×¦×™×™×Ÿ/×™ ×‘×“×™×•×§ ××™×¤×”, ×•×¤×ª×•×¨/×™ ××—×“×© ×©×œ×‘-××—×¨-×©×œ×‘.
×‘×¡×•×£ ×ª×Ÿ/×™ ×©××œ×” ×§×¦×¨×” ××—×ª ×œ×‘×“×™×§×” ×¢×¦××™×ª (×‘×œ×™ ×¤×ª×¨×•×Ÿ).`
      }
    ];

    // =========================
    // Rendering helpers
    // =========================
    function buildPromptDetails(item) {
      const d = document.createElement('details');
      d.className = 'prompt';

      const s = document.createElement('summary');

      const left = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'prompt-title';
      title.textContent = item.title;

      const desc = document.createElement('div');
      desc.className = 'prompt-desc';
      desc.textContent = item.desc || '';

      left.appendChild(title);
      if (item.desc) left.appendChild(desc);

      const copyBtn = document.createElement('button');
      copyBtn.type = 'button';
      copyBtn.className = 'copy-btn';
      copyBtn.textContent = '×”×¢×ª×§';

      copyBtn.addEventListener('click', async (e) => {
        // ×—×©×•×‘: ×œ× ×œ×¤×ª×•×—/×œ×¡×’×•×¨ ××ª <details> ×‘×¢×ª ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×¢×ª×§
        e.preventDefault();
        e.stopPropagation();
        await copyToClipboard(item.text, copyBtn);
      });

      s.appendChild(left);
      s.appendChild(copyBtn);

      const body = document.createElement('div');
      body.className = 'prompt-body';

      const pre = document.createElement('pre');
      pre.className = 'prompt-text';
      pre.textContent = item.text;

      body.appendChild(pre);

      d.appendChild(s);
      d.appendChild(body);

      return d;
    }

    function renderPromptList(items, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      items.forEach(item => container.appendChild(buildPromptDetails(item)));
    }

    async function copyToClipboard(text, btnEl) {
      const original = btnEl.textContent;

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          fallbackCopy(text);
        }
      } catch (e) {
        fallbackCopy(text);
      }

      btnEl.textContent = '×”×•×¢×ª×§ âœ“';
      btnEl.classList.add('copied');

      window.setTimeout(() => {
        btnEl.textContent = original;
        btnEl.classList.remove('copied');
      }, 1200);
    }

    function fallbackCopy(text) {
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      ta.style.top = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }

    // =========================
    // Dark Mode
    // =========================
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('galibot_theme', theme);

      const btn = document.getElementById('themeToggleBtn');
      if (theme === 'dark') {
        btn.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
      } else {
        btn.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
      }
    }

    function initTheme() {
      const saved = localStorage.getItem('galibot_theme');
      if (saved === 'dark' || saved === 'light') {
        setTheme(saved);
        return;
      }
      // ×‘×¨×™×¨×ª ××—×“×œ ×œ×¤×™ ××¢×¨×›×ª
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      setTheme(prefersDark ? 'dark' : 'light');
    }

    // =========================
    // Mobile Sidebar Drawer
    // =========================
    function setSidebarOpen(open) {
      const sidebar = document.getElementById('sidebar');
      const scrim = document.getElementById('scrim');

      if (open) {
        sidebar.classList.add('open');
        scrim.classList.add('open');
      } else {
        sidebar.classList.remove('open');
        scrim.classList.remove('open');
      }
    }

    // =========================
    // Chat (Streaming)
    // =========================
    let currentBotMessage = null;
    let attachedImageFile = null;
    let attachedImageObjectUrl = null;
    const chatHistory = [];

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    function formatBytes(bytes) {
      if (bytes < BYTES_PER_KB) return `${bytes} B`;
      if (bytes < BYTES_PER_KB * KB_PER_MB) return `${(bytes / BYTES_PER_KB).toFixed(1)} KB`;
      return `${(bytes / (BYTES_PER_KB * KB_PER_MB)).toFixed(1)} MB`;
    }

    function validateImageFile(file) {
      if (!file) {
        return { ok: false, message: '×œ× × ×‘×—×¨×” ×ª××•× ×”.' };
      }
      if (!ALLOWED_IMAGE_TYPES.has(file.type)) {
        return { ok: false, message: '×¡×•×’ ×”×§×•×‘×¥ ××™× ×• × ×ª××š. ×™×© ×œ×‘×—×•×¨ PNG / JPEG / WEBP.' };
      }
      if (file.size > MAX_IMAGE_BYTES) {
        return { ok: false, message: '×”×ª××•× ×” ×’×“×•×œ×” ××“×™. × ×¡×• ×ª××•× ×” ×¢×“ 10MB.' };
      }
      return { ok: true };
    }

    function truncateText(text, maxChars) {
      if (!text || typeof text !== 'string') return '';
      if (text.length <= maxChars) return text;
      return text.slice(0, maxChars);
    }

    function normalizeHistoryContent(text) {
      return truncateText(String(text || '').trim(), HISTORY_MAX_MESSAGE_CHARS);
    }

    function pushToHistory(role, content) {
      const normalized = normalizeHistoryContent(content);
      if (!normalized) return;
      chatHistory.push({ role, content: normalized });
      if (chatHistory.length > HISTORY_MAX_BUFFER_TURNS) {
        chatHistory.splice(0, chatHistory.length - HISTORY_MAX_BUFFER_TURNS);
      }
    }

    function getBoundedHistory(history, maxTurns, maxTotalChars) {
      const recent = history.slice(-maxTurns);
      let remaining = maxTotalChars;
      const bounded = [];

      for (let i = recent.length - 1; i >= 0; i -= 1) {
        const item = recent[i];
        let content = normalizeHistoryContent(item.content);
        if (!content) continue;
        if (content.length > remaining) {
          content = content.slice(0, remaining);
        }
        if (!content) continue;
        remaining -= content.length;
        bounded.push({ role: item.role, content });
        if (remaining <= 0) break;
      }

      return bounded.reverse();
    }

    function updateImagePreview() {
      const preview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('imagePreviewImg');
      const previewMeta = document.getElementById('imagePreviewMeta');

      if (!attachedImageFile) {
        preview.classList.remove('active');
        previewImg.removeAttribute('src');
        previewMeta.textContent = '';
        return;
      }

      preview.classList.add('active');
      previewImg.src = attachedImageObjectUrl;
      previewMeta.textContent = `${attachedImageFile.name} â€¢ ${formatBytes(attachedImageFile.size)}`;
    }

    function setAttachedImage(file) {
      const validation = validateImageFile(file);
      if (!validation.ok) {
        alert(validation.message);
        return false;
      }

      if (attachedImageObjectUrl) {
        URL.revokeObjectURL(attachedImageObjectUrl);
      }
      attachedImageFile = file;
      attachedImageObjectUrl = URL.createObjectURL(file);
      updateImagePreview();
      return true;
    }

    function clearImageAttachment() {
      const imageInput = document.getElementById('imageInput');
      if (attachedImageObjectUrl) {
        URL.revokeObjectURL(attachedImageObjectUrl);
      }
      attachedImageFile = null;
      attachedImageObjectUrl = null;
      imageInput.value = '';
      updateImagePreview();
    }

    function clearAttachedImage() {
      clearImageAttachment();
    }

    async function uploadImage(email, file) {
      const formData = new FormData();
      formData.append('email', email);
      formData.append('image', file);

      const response = await fetch(UPLOAD_URL, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        const responseText = await response.text();
        let errorMessage = `×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×” (${response.status})`;
        try {
          const payload = JSON.parse(responseText);
          errorMessage = payload.message || payload.error || errorMessage;
        } catch (e) {
          if (responseText) errorMessage = responseText;
        }
        throw new Error(errorMessage);
      }

      const payload = await response.json();
      if (!payload || !payload.image_id) {
        throw new Error('×ª×©×•×‘×ª ×”×¢×œ××” ×œ× ×ª×§×™× ×”.');
      }
      return payload;
    }

    async function sendMessage() {
      const email = document.getElementById('emailInput').value.trim();
      const prompt = document.getElementById('messageInput').value.trim();
      const sendButton = document.getElementById('sendButton');
      const status = document.getElementById('status');

      if (!email || !prompt) {
        alert('×× × ××œ×/×™ ××ª ×”××™×™×œ ×•×”×©××œ×”');
        return;
      }

      // ×”×•×¡×¤×ª ×”×•×“×¢×ª ×”××©×ª××©
      addMessage('user', prompt);
      pushToHistory('user', prompt);
      document.getElementById('messageInput').value = '';
      sendButton.disabled = true;

      status.textContent = '×××ª×™×Ÿ ×œ×ª×©×•×‘×”...';
      status.classList.add('streaming');

      // ×™×¦×™×¨×ª ×”×•×“×¢×ª ×‘×•×˜ ×¨×™×§×”
      currentBotMessage = addMessage('bot', '');
      let assistantHistoryRecorded = false;

      const cleanupUI = () => {
        status.classList.remove('streaming');
        sendButton.disabled = false;
      };

      const controller = new AbortController();
      const IDLE_MS = 60000;
      const MAX_MS = 180000;
      let idleTimeoutId = null;
      let maxTimeoutId = null;

      const startIdleTimer = () => {
        idleTimeoutId = window.setTimeout(() => controller.abort(), IDLE_MS);
      };

      const resetIdleTimer = () => {
        window.clearTimeout(idleTimeoutId);
        startIdleTimer();
      };

      startIdleTimer();
      maxTimeoutId = window.setTimeout(() => controller.abort(), MAX_MS);

      try {
        let imageId = null;
        if (attachedImageFile) {
          status.textContent = '××¢×œ×” ×ª××•× ×”...';
          const uploadResult = await uploadImage(email, attachedImageFile);
          imageId = uploadResult.image_id;
        }

        status.textContent = '×××ª×™×Ÿ ×œ×ª×©×•×‘×”...';

        const payload = { email, prompt, history: getBoundedHistory(chatHistory, HISTORY_MAX_TURNS, HISTORY_MAX_TOTAL_CHARS) };
        if (imageId) payload.image_id = imageId;

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullAnswer = '';
        let sources = null;
        let stopReading = false;
        const finalizeAssistantHistory = () => {
          if (assistantHistoryRecorded) return;
          const finalText = currentBotMessage?.textContent || fullAnswer;
          pushToHistory('assistant', finalText);
          assistantHistoryRecorded = true;
        };

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          resetIdleTimer();
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.trim() === '') continue;

            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (data.type === 'token') {
                  fullAnswer += data.content;
                  updateBotMessage(fullAnswer);
                } else if (data.type === 'sources') {
                  sources = data.sources;
                } else if (data.type === 'done') {
                  if (sources && sources.length > 0) {
                    // ×”×¡×¨×ª ×›×¤×™×œ×•×™×•×ª - ×›×œ ×§×•×‘×¥ ××•×¦×’ ×¨×§ ×¤×¢× ××—×ª
                    const uniqueFiles = new Set();
                    sources.forEach((s) => {
                      if (s.source) {
                        const fileName = s.source.split('/').pop().split('\\').pop();
                        uniqueFiles.add(fileName);
                      }
                    });
                    
                    // ×”×¦×’×ª ××§×•×¨×•×ª ×‘×¦×•×¨×” ××™× ×™××œ×™×ª - ×¨×§ ×©× ×§×•×‘×¥ ×‘×¡×•×’×¨×™×™×, ×œ×œ× ×›×¤×™×œ×•×™×•×ª
                    const sourcesText = Array.from(uniqueFiles).map(fileName => `(${fileName})`).join(' ');

                    if (sourcesText) {
                      updateBotMessage(fullAnswer + ' ' + sourcesText);
                    }
                  }
                  stopReading = true;
                  finalizeAssistantHistory();
                  break;
                } else if (data.type === 'error') {
                  throw new Error(data.message);
                }
              } catch (e) {
                console.error('Parse error:', e, 'Line:', line);
              }
            } else if (line.startsWith(': ')) {
              continue; // comment line
            }
          }

          if (stopReading) break;
        }

        if (!assistantHistoryRecorded) {
          finalizeAssistantHistory();
        }
      } catch (error) {
        console.error('Error:', error);
        if (error?.name === 'AbortError') {
          updateBotMessage('×”×—×™×‘×•×¨ ×”×ª×¢×›×‘/× ×•×ª×§. × ×¡×™ ×©×•×‘.');
        } else {
          updateBotMessage('×©×’×™××”: ' + error.message);
        }
      } finally {
        window.clearTimeout(idleTimeoutId);
        window.clearTimeout(maxTimeoutId);
        cleanupUI();
        if (currentBotMessage && !assistantHistoryRecorded) {
          pushToHistory('assistant', currentBotMessage.textContent || '');
        }
        if (attachedImageFile) {
          clearImageAttachment();
        }
        if (window.MathJax?.typesetPromise) {
          const messagesDiv = document.getElementById('chatMessages');
          window.MathJax.typesetPromise([messagesDiv]).catch(err => {
            console.log('MathJax typeset error:', err);
          });
        }
      }
    }

    function addMessage(type, text) {
      const messagesDiv = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      messageDiv.textContent = text;
      messagesDiv.appendChild(messageDiv);
      messageDiv.scrollIntoView({ behavior: 'smooth' });

      return messageDiv;
    }

    function updateBotMessage(text) {
      if (currentBotMessage) {
        currentBotMessage.textContent = text;
        currentBotMessage.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // =========================
    // Init
    // =========================
    (function init() {
      // ×¤×¨×•××¤×˜×™×
      renderPromptList(BASIC_PROMPTS, 'basicPrompts');
      renderPromptList(ADVANCED_PROMPTS, 'advancedPrompts');

      // Dark mode
      initTheme();
      document.getElementById('themeToggleBtn').addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        setTheme(current === 'dark' ? 'light' : 'dark');
      });

      // Mobile drawer controls
      const openBtn = document.getElementById('openSidebarBtn');
      const closeBtn = document.getElementById('closeSidebarBtn');
      const scrim = document.getElementById('scrim');

      openBtn.addEventListener('click', () => setSidebarOpen(true));
      closeBtn.addEventListener('click', () => setSidebarOpen(false));
      scrim.addEventListener('click', () => setSidebarOpen(false));

      const attachButton = document.getElementById('attachButton');
      const imageInput = document.getElementById('imageInput');
      const removeImageButton = document.getElementById('removeImageButton');
      const messageInput = document.getElementById('messageInput');

      attachButton.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', (event) => {
        const file = event.target.files && event.target.files[0];
        if (file) setAttachedImage(file);
      });

      removeImageButton.addEventListener('click', () => clearImageAttachment());

      messageInput.addEventListener('paste', (event) => {
        const items = event.clipboardData?.items || [];
        for (const item of items) {
          if (item.kind === 'file' && item.type.startsWith('image/')) {
            const file = item.getAsFile();
            if (file && setAttachedImage(file)) {
              event.preventDefault();
              return;
            }
          }
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') setSidebarOpen(false);
      });
    })();
  </script>
</body>
</html>