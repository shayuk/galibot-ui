<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×œ×•×— × ×™×”×•×œ â€“ ×§×‘×¦×™× ×©×”×•×¢×œ×•</title>

  <!-- Firebase SDKs (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #f8fafc;
      padding: 20px;
      direction: rtl;
    }
    h1 {
      color: #2563eb;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sub {
      color: #64748b;
      margin-bottom: 14px;
      font-size: 0.95rem;
    }
    .loading {
      color: #555;
      margin-top: 10px;
    }
    .error {
      color: #b91c1c;
      margin-top: 10px;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      background: white;
    }
    th, td {
      border: 1px solid #d1d5db;
      padding: 10px 12px;
      text-align: center;
    }
    th {
      background: #e0e7ff;
      font-weight: 700;
    }
    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #1e3a8a;
      font-size: 0.85rem;
    }
    .topbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    input[type="text"]{
      padding: 8px 10px;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      min-width: 220px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>

<body>
  <h1>ğŸ“Š ×œ×•×— × ×™×”×•×œ â€“ ×§×‘×¦×™× ×©×”×•×¢×œ×• <span class="pill">Firestore / rag_chunks</span></h1>
  <div class="sub">×× ××ª ×¨×•××” â€œMissing permissionsâ€ â€“ ×–×” ××•××¨ ×©××™×Ÿ ×”×ª×—×‘×¨×•×ª ××• ×©×”-Rules ×œ× ×¤×•×¨×¡××•.</div>

  <div class="topbar">
    <label>
      ×¡×™× ×•×Ÿ ×œ×¤×™ ××§×•×¨/×§×•×¨×¡:
      <input id="search" type="text" placeholder="×œ××©×œ: ×©×™×¢×•×¨ 1 ××• statistics" />
    </label>
    <button id="refreshBtn">×¨×¢× ×•×Ÿ</button>
  </div>

  <div id="status" class="loading">××ª×—×‘×¨ ×œ-Firebaseâ€¦</div>

  <table id="results" style="display:none">
    <thead>
      <tr>
        <th>ğŸ“„ ××§×•×¨</th>
        <th>ğŸ“š ×§×•×¨×¡</th>
        <th>ğŸ”¢ ××¡×¤×¨ ×§×˜×¢×™×</th>
        <th>ğŸ“… ×”×¢×œ××” ××—×¨×•× ×”</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    /*********************************************************
     * 1) Firebase Config â€“ ×–×” ××¤×ª×— ×©×œ Firebase (Web API Key)
     *    ×œ× ×œ×”×“×‘×™×§ ×›××Ÿ OpenAI key ×‘×©×•× ××¦×‘.
     *********************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_WEB_API_KEY",
      authDomain: "lecturers-gpt-auth.firebaseapp.com",
      projectId: "lecturers-gpt-auth"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const statusEl = document.getElementById('status');
    const tableEl = document.getElementById('results');
    const tbodyEl = tableEl.querySelector('tbody');
    const searchEl = document.getElementById('search');
    const refreshBtn = document.getElementById('refreshBtn');

    let groupedRows = [];

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = type || "loading";
    }

    function renderTable(filterText = "") {
      tbodyEl.innerHTML = "";

      const q = (filterText || "").trim().toLowerCase();
      const rows = q
        ? groupedRows.filter(r =>
            (r.source || "").toLowerCase().includes(q) ||
            (r.course_name || "").toLowerCase().includes(q)
          )
        : groupedRows;

      if (rows.length === 0) {
        tableEl.style.display = "none";
        setStatus("×œ× × ××¦××• × ×ª×•× ×™× ×œ×”×¦×’×” (××•×œ×™ ×”×¡×™× ×•×Ÿ ××—××™×¨ ××“×™).", "loading");
        return;
      }

      for (const row of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.source || "â€”"}</td>
          <td>${row.course_name || "â€”"}</td>
          <td>${row.count || 0}</td>
          <td>${row.lastUploadedAt ? row.lastUploadedAt.toLocaleString() : "â€”"}</td>
        `;
        tbodyEl.appendChild(tr);
      }

      setStatus("");
      tableEl.style.display = "table";
    }

    async function loadData() {
      refreshBtn.disabled = true;
      tableEl.style.display = "none";
      tbodyEl.innerHTML = "";
      setStatus("×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦", "loading");

      try {
        // ×§×¨×™××” ×-rag_chunks. ×”-Rules ×¦×¨×™×›×™× ×œ××¤×©×¨ read ××—×¨×™ auth.
        const snapshot = await db.collection("rag_chunks").limit(500).get();

        if (snapshot.empty) {
          groupedRows = [];
          renderTable(searchEl.value);
          setStatus("×œ× × ××¦××• × ×ª×•× ×™× ×‘-rag_chunks.", "loading");
          refreshBtn.disabled = false;
          return;
        }

        const grouped = {};

        snapshot.forEach(doc => {
          const d = doc.data();
          const key = `${d.course_name || ""}__${d.source || ""}`;

          if (!grouped[key]) {
            grouped[key] = {
              source: d.source || "â€”",
              course_name: d.course_name || "â€”",
              count: 0,
              lastUploadedAt: null
            };
          }

          grouped[key].count++;

          const uploadedAt = d.uploaded_at || (d.metadata && d.metadata.uploaded_at);
          if (uploadedAt) {
            const date = new Date(uploadedAt);
            if (!grouped[key].lastUploadedAt || date > grouped[key].lastUploadedAt) {
              grouped[key].lastUploadedAt = date;
            }
          }
        });

        groupedRows = Object.values(grouped)
          .sort((a, b) => {
            const ta = a.lastUploadedAt ? a.lastUploadedAt.getTime() : 0;
            const tb = b.lastUploadedAt ? b.lastUploadedAt.getTime() : 0;
            return tb - ta;
          });

        renderTable(searchEl.value);
        refreshBtn.disabled = false;
      } catch (err) {
        console.error(err);
        setStatus("âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× (×‘×“×§×™ Firestore Rules + Publish + Anonymous Enabled).", "error");
        refreshBtn.disabled = false;
      }
    }

    // 2) ×”×ª×—×‘×¨×•×ª ×× ×•× ×™××™×ª (×—×™×™×‘ ×œ×”×™×•×ª Enabled ×‘-Authentication)
    auth.signInAnonymously()
      .then(() => {
        console.log("Signed in anonymously");
        loadData();
        setInterval(loadData, 5000);
      })
      .catch((err) => {
        console.error("Auth error:", err);
        setStatus("âŒ ×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ-Firebase (×‘×“×§×™ ×©×”×¤×¢×œ×ª Anonymous ×‘-Authentication).", "error");
      });

    // UI events
    searchEl.addEventListener("input", () => renderTable(searchEl.value));
    refreshBtn.addEventListener("click", loadData);
  </script>
</body>
</html>
