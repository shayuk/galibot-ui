<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>העלאת PDF לחומרי קורס</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f4f8;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    form {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    input, label, button {
      font-size: 1rem;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .success {
      color: green;
      margin-top: 10px;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <form id="uploadForm">
    <input type="hidden" name="email" value="shayuk@ariel.ac.il">

    <label>בחרי קובצי PDF (עד 3 קבצים):</label>
    <input type="file" name="pdf" accept="application/pdf" multiple>

    <label>או הדביקי כאן טקסט ישיר:</label>
    <textarea name="text" rows="4" placeholder="תוכן חומרי הקורס כאן..."></textarea>

    <label>מקור / כותרת:</label>
    <input type="text" name="source" value="שיעור 1">

    <label>שם הקורס:</label>
    <input type="text" name="course_name" value="statistics">

    <button type="submit">העלאה</button>
    <div id="message"></div>
  </form>

  <script>
    const form = document.getElementById('uploadForm');
    const message = document.getElementById('message');

form.addEventListener('submit', async (e) => {
        message.textContent = '';
        message.className = '';
        e.preventDefault();

        const email = form.querySelector('input[name="email"]').value.trim();
        const source = form.querySelector('input[name="source"]').value.trim();
        const course = form.querySelector('input[name="course_name"]').value.trim() || 'statistics';
        const text = form.querySelector('textarea[name="text"]').value.trim();
        const files = form.querySelector('input[name="pdf"]').files;

        // אם הוזן טקסט, נשלח אותו כ-JSON
        if (text) {
          try {
            const res = await fetch('/api/upload-course-material', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: email,
                text: text,
                source: source || undefined,
                course_name: course || undefined
              })
            });
            const data = await res.json().catch(() => ({}));
            if (res.ok) {
              const chunks = data.chunksCount ?? data.chunks_saved ?? data.chunks ?? 0;
              message.textContent = `✔ הטקסט הועלה בהצלחה (${chunks} קטעים נשמרו).`;
              message.className = 'success';
            } else {
              message.textContent = `❌ שגיאה – ${data.error || data.message || 'קרתה תקלה'}`;
              message.className = 'error';
            }
          } catch (err) {
            message.textContent = '❌ שגיאה בתקשורת עם השרת.';
            message.className = 'error';
          }
          return;
        }

        // אם לא נבחרו קבצים ואין טקסט – הצג שגיאה
        if (!files || files.length === 0) {
          message.textContent = '❌ אנא בחרי לפחות קובץ אחד או הדביקי טקסט.';
          message.className = 'error';
          return;
        }

        // בדיקת מספר קבצים
        if (files.length > 3) {
          message.textContent = '❌ ניתן להעלות עד 3 קבצי PDF בכל פעם.';
          message.className = 'error';
          return;
        }

        // העלאת כל קובץ בנפרד
        for (const file of files) {
          const fileData = new FormData();
          fileData.append('email', email);
          fileData.append('pdf', file);
          if (source) fileData.append('source', source);
          if (course) fileData.append('course_name', course);
          try {
            const res = await fetch('/api/upload-course-material', {
              method: 'POST',
              body: fileData
            });
            const data = await res.json().catch(() => ({}));
            if (res.ok) {
              const chunks = data.chunksCount ?? data.chunks_saved ?? data.chunks ?? 0;
              message.textContent += `\n✔ ${file.name}: ${chunks} קטעים נשמרו.`;
              message.className = 'success';
            } else {
              message.textContent += `\n❌ ${file.name}: שגיאה – ${data.error || data.message || 'קרתה תקלה'}`;
              message.className = 'error';
            }
          } catch (err) {
            message.textContent += `\n❌ ${file.name}: שגיאה בתקשורת עם השרת.`;
            message.className = 'error';
          }
        }
      });
  </script>
</body>
</html>
